# 最终实现


## Oracle 积分数据修复
144546条数据，14691用户，6s左右
添加索引
```sql
create Index points_detail_user on SYS_POINTS_DETAIL(user_id);
```
先查总人数，每次查100R 
```sql
declare  
    v_now           date := sysdate;
    v_root_site_id      sys_site.id%type;
    v_system_user_id      sys_user.id%type;
    v_user_count  SYS_POINTS_DETAIL.user_id%type;
    v_id               SYS_POINTS_SUM_DETAIL.id%type; 
    pageNumber    NUMBER(11);
    pageSize      NUMBER(11) := 100;  
    pageOffset     NUMBER(11) := 0;  
    obtainScoreSum SYS_POINTS_DETAIL.obtain_score%type :=0;
    obtainScoreActualSum SYS_POINTS_DETAIL.obtain_score%type :=0;
    usedScoreSum SYS_POINTS_DETAIL.obtain_score%type :=0;
    endDateScoreSum SYS_POINTS_DETAIL.obtain_score%type :=0;
BEGIN
  SELECT COUNT(DISTINCT  user_id) INTO v_user_count FROM SYS_POINTS_DETAIL;
  select min(id) into v_system_user_id from sys_user;
  SELECT MAX(id) INTO v_id FROM SYS_POINTS_SUM_DETAIL;
  FOR a_type In (SELECT id FROM SYS_POINTS_TYPE) LOOP
    pageNumber := CEIL(v_user_count / pageSize)-1;
    FOR a IN 0 .. pageNumber LOOP
      pageOffset :=  pageSize*a;
      FOR userObj IN ( SELECT * FROM ( SELECT user_id,site_id,ROWNUM RN_ FROM (SELECT DISTINCT user_id,site_id FROM SYS_POINTS_DETAIL )u)u2 WHERE RN_ > pageOffset AND RN_ <= pageOffset+pageSize  ) LOOP
        SELECT SUM(obtain_score) INTO obtainScoreSum FROM SYS_POINTS_DETAIL WHERE user_id = userObj.user_id AND site_id = userObj.site_id;
        SELECT SUM(obtain_score_actual) INTO obtainScoreActualSum FROM SYS_POINTS_DETAIL WHERE user_id = userObj.user_id AND site_id = userObj.site_id AND status in ('EFFECT','USED') ;
        SELECT SUM(obtain_score_actual) INTO endDateScoreSum FROM SYS_POINTS_DETAIL WHERE user_id = userObj.user_id AND site_id = userObj.site_id  AND status = 'ENDDATE' ;     
        IF (v_id IS NULL) THEN
            v_id := 0;
        END IF; 
        v_id := v_id + 1;
        IF (obtainScoreActualSum IS NULL) THEN
          obtainScoreSum := 0;
        END IF; 
        IF (endDateScoreSum IS NULL) THEN
          endDateScoreSum := 0;
        END IF; 
        usedScoreSum := obtainScoreSum - obtainScoreActualSum - endDateScoreSum;
        INSERT INTO SYS_POINTS_SUM_DETAIL(ID,CREATED_DATE,LAST_MODIFIED_DATE,IS_DELETED,CREATED_BY,LAST_MODIFIED_BY,OBTAIN_SCORE_SUM,OBTAIN_SCORE_ACTUAL_SUM,USED_SCORE_SUM,END_DATE_SCORE_SUM,POINTS_TYPE_ID,USER_ID,SITE_ID)VALUES(v_id,v_now,v_now,0,v_system_user_id,v_system_user_id,obtainScoreSum,obtainScoreActualSum,usedScoreSum,endDateScoreSum,a_type.id,userObj.user_id,userObj.site_id);
      END LOOP;
    END LOOP;
  END LOOP;
COMMIT;
END;
/
```

## Mysql 积分数据修复。

167040条数据，7748用户，17s左右
```sql
-- 添加索引
ALTER TABLE SYS_POINTS_DETAIL ADD INDEX points_detail_user ( `user_id` );

-- 数据修复
DELIMITER $$
DROP PROCEDURE IF EXISTS sumPoints $$
CREATE PROCEDURE sumPoints()
BEGIN
  DECLARE  v_root_site_id bigint default 0; 
  DECLARE  v_system_user_id bigint default 0;
  DECLARE  v_user_count int default 0;
  DECLARE  v_id bigint default 0;
  DECLARE  v_now datetime;
  
  DECLARE  obtainScoreSum int default 0;
  DECLARE  obtainScoreActualSum int default 100;
  DECLARE  usedScoreSum int default 0;
  DECLARE  endDateScoreSum int default 0;
  DECLARE  points_type_id bigint default 0;
  DECLARE  p_user_id bigint default 0; 
  DECLARE  p_site_id bigint default 0; 
  DECLARE stopFlag INT DEFAULT 0;
  DECLARE user_count INT DEFAULT 0;
  DECLARE  points_type_cur CURSOR FOR SELECT id FROM SYS_POINTS_TYPE;
  DECLARE  user_cur CURSOR FOR SELECT DISTINCT user_id,site_id FROM SYS_POINTS_DETAIL;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET stopFlag = 1;

  
  SELECT min(id) INTO v_root_site_id FROM sys_site;
  SELECT min(id) INTO v_system_user_id FROM sys_user;
  SELECT COUNT(DISTINCT  user_id) INTO v_user_count FROM SYS_POINTS_DETAIL;
  SELECT MAX(id) INTO v_id FROM SYS_POINTS_SUM_DETAIL;
  SET v_now = now();

  OPEN points_type_cur;

  points_type_loop: LOOP
		FETCH points_type_cur INTO points_type_id;
		SET user_count = 0;
    IF stopFlag = 1 THEN
			LEAVE points_type_loop;
		END IF;
      
		OPEN user_cur;
		user_loop: LOOP
			FETCH user_cur INTO p_user_id,p_site_id;
			IF stopFlag = 1 THEN
				LEAVE user_loop;
			END IF;

		
			SELECT SUM(obtain_score) INTO obtainScoreSum FROM SYS_POINTS_DETAIL WHERE user_id = p_user_id AND site_id = p_site_id;
			SELECT SUM(obtain_score_actual) INTO obtainScoreActualSum FROM SYS_POINTS_DETAIL WHERE user_id = p_user_id AND site_id = site_id AND status in ('EFFECT','USED') ;
			SELECT SUM(obtain_score_actual) INTO endDateScoreSum FROM SYS_POINTS_DETAIL WHERE user_id = p_user_id AND site_id = site_id  AND status = 'ENDDATE' ; 
			
			IF (v_id IS NULL) THEN
				SET v_id = 0;
			END IF; 
			SET v_id = v_id + 1;

			IF (obtainScoreActualSum IS NULL) THEN
				SET obtainScoreSum = 0;
			END IF; 

			IF (endDateScoreSum IS NULL) THEN
				SET endDateScoreSum = 0;
			END IF;  

			SET usedScoreSum = obtainScoreSum - obtainScoreActualSum - endDateScoreSum;
			
			INSERT INTO SYS_POINTS_SUM_DETAIL(ID,CREATED_DATE,LAST_MODIFIED_DATE,IS_DELETED,CREATED_BY,LAST_MODIFIED_BY,OBTAIN_SCORE_SUM,OBTAIN_SCORE_ACTUAL_SUM,USED_SCORE_SUM,END_DATE_SCORE_SUM,POINTS_TYPE_ID,USER_ID,SITE_ID)VALUES(v_id,v_now,v_now,0,v_system_user_id,v_system_user_id,obtainScoreSum,obtainScoreActualSum,usedScoreSum,endDateScoreSum,points_type_id,p_user_id,p_site_id);
			SET user_count = user_count +1;
			IF user_count = v_user_count THEN
					SET stopFlag = 1;
			END IF;
		END LOOP user_loop;
		CLOSE user_cur;
		SET stopFlag=0;
	
  END LOOP points_type_loop;
  CLOSE points_type_cur;
-- 	SELECT p_user_id,obtainScoreSum;
END $$
DELIMITER ;
-- 执行存储过程
call sumPoints();
-- 删除存储过程
drop procedure if exists sumPoints
```